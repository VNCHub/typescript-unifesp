{
  "version": 3,
  "sources": ["../../src/frontend/HomeFrontend.ts"],
  "sourcesContent": ["declare const bootstrap: any;\n\nimport { IUser } from '../models/User';\nimport { IEnrollment } from '../models/Enrollment';\nimport { ISubject } from '../models/Subject';\n\nexport class HomeFrontend {\n  private API_SUBJECTS = \"/api/subjects\";\n  private API_ENROLLMENT = \"/api/enrollment\";\n  private API_ME = \"/api/me\";\n  \n  private currentUser: IUser | null = null;\n  private userEnrollments: IEnrollment[] = [];\n\n  async init() {\n    await this.loadCurrentUser();\n    this.loadAndRender();\n    \n    document.addEventListener(\"click\", async (e) => {\n      const target = e.target as HTMLElement;\n      \n      if (target?.dataset?.edit?.endsWith(\"-details\")) {\n        const id = Number(target.dataset.edit.replace(\"-details\", \"\"));\n        await this.openDetailsModal(id);\n      }\n      \n      if (target?.dataset?.enroll) {\n        const subjectId = Number(target.dataset.enroll);\n        await this.handleEnroll(subjectId);\n      }\n      \n      if (target?.dataset?.unenroll) {\n        const enrollmentId = Number(target.dataset.unenroll);\n        await this.handleUnenroll(enrollmentId);\n      }\n    });\n  }\n\n  private async loadCurrentUser() {\n    try {\n      const token = localStorage.getItem('token');\n      if (!token) {\n        this.currentUser = null;\n        return;\n      }\n\n      const res = await fetch(this.API_ME, {\n        headers: { 'Authorization': `Bearer ${token}` }\n      });\n      \n      if (!res.ok) {\n        // Token inv\u00E1lido ou expirado\n        localStorage.removeItem('token');\n        this.currentUser = null;\n        return;\n      }\n      \n      this.currentUser = await res.json();\n      if (this.currentUser?.id) {\n        await this.loadUserEnrollments();\n      }\n    } catch (err) {\n      console.error(\"Erro ao carregar usu\u00E1rio:\", err);\n      this.currentUser = null;\n    }\n  }\n\n  private async loadUserEnrollments() {\n    try {\n      const token = localStorage.getItem('token');\n      const res = await fetch(`${this.API_ENROLLMENT}/user/${this.currentUser!.id}`, {\n        headers: { 'Authorization': `Bearer ${token}` }\n      });\n      console.log(res.json);\n      \n      if (res.ok) {\n        this.userEnrollments = await res.json();\n      }\n    } catch (err) {\n      console.error(\"Erro ao carregar matr\u00EDculas:\", err);\n    }\n  }\n\n  private async openDetailsModal(id: number) {\n    const res = await fetch(`${this.API_SUBJECTS}/${id}`);\n    const subject = await res.json();\n\n    (this.$(\"#detail-nome\") as HTMLElement).textContent = subject.nome;\n    (this.$(\"#detail-descricao\") as HTMLElement).textContent = subject.descricao ?? \"\u2014\";\n    (this.$(\"#detail-professor\") as HTMLElement).textContent = subject.professor?.nome ?? \"\u2014\";\n    (this.$(\"#detail-horario\") as HTMLElement).textContent = subject.horario ?? \"\u2014\";\n    (this.$(\"#detail-sala\") as HTMLElement).textContent = subject.sala ?? \"\u2014\";\n\n    this.loadNotes(id);\n\n    const modal = new bootstrap.Modal(this.$(\"#subjectDetailsModal\")!);\n    modal.show();\n  }\n\n  private async handleEnroll(subjectId: number) {\n    try {\n      const token = localStorage.getItem('token');\n      \n      if (!token || !this.currentUser) {\n        alert(\"Voc\u00EA precisa fazer login para se matricular\");\n        return;\n      }\n\n      const alunoId = this.currentUser?.aluno?.id;\n\n      if (!alunoId) {\n        alert(\"Erro: Usu\u00E1rio n\u00E3o possui registro de aluno\");\n        return;\n      }\n\n      const res = await fetch(this.API_ENROLLMENT, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${token}`\n        },\n        body: JSON.stringify({\n          alunoId: alunoId,\n          materiaId: subjectId\n        })\n      });\n\n      if (res.ok) {\n        await this.loadUserEnrollments();\n        await this.loadAndRender();\n        alert(\"Matr\u00EDcula realizada com sucesso!\");\n      } else {\n        const error = await res.json();\n        alert(`Erro: ${error.error}`);\n      }\n    } catch (err) {\n      console.error(\"Erro ao matricular:\", err);\n      alert(\"Erro ao realizar matr\u00EDcula\");\n    }\n  }\n\n  private async handleUnenroll(enrollmentId: number) {\n    if (!confirm(\"Deseja realmente se desmatricular?\")) return;\n\n    try {\n      const token = localStorage.getItem('token');\n      const res = await fetch(`${this.API_ENROLLMENT}/${enrollmentId}`, {\n        method: 'DELETE',\n        headers: { 'Authorization': `Bearer ${token}` }\n      });\n\n      if (res.ok) {\n        await this.loadUserEnrollments();\n        await this.loadAndRender();\n        alert(\"Desmatriculado com sucesso!\");\n      } else {\n        const error = await res.json();\n        alert(`Erro: ${error.error}`);\n      }\n    } catch (err) {\n      console.error(\"Erro ao desmatricular:\", err);\n      alert(\"Erro ao realizar desmatr\u00EDcula\");\n    }\n  }\n\n  private async loadNotes(subjectId: number) {\n    const list = this.$(\"#notes-list\")!;\n    list.innerHTML = `\n      <li class=\"list-group-item text-center text-muted\" id=\"notes-loading\">\n        <div class=\"spinner-border spinner-border-sm me-2\"></div>\n        Carregando notas...\n      </li>\n    `;\n\n    const res = await fetch(`/api/subjects/${subjectId}/notes`);\n    const notes = await res.json();\n\n    list.innerHTML = \"\";\n\n    if (!notes.length) {\n      list.innerHTML = `\n        <li class=\"list-group-item text-center text-muted\">\n          Nenhuma nota ainda.\n        </li>\n      `;\n      return;\n    }\n\n    for (const n of notes) {\n      const li = document.createElement(\"li\");\n      li.className = \"list-group-item d-flex justify-content-between align-items-center\";\n      li.innerHTML = `\n        <span>${this.escapeHtml(n.texto)}</span>\n        <div>\n          <button class=\"btn btn-sm btn-outline-secondary me-1\" data-edit-note=\"${n.id}\">Editar</button>\n          <button class=\"btn btn-sm btn-outline-danger\" data-delete-note=\"${n.id}\">Excluir</button>\n        </div>\n      `;\n      list.appendChild(li);\n    }\n  }\n\n  private $(sel: string): HTMLElement | null {\n    return document.querySelector(sel);\n  }\n\n  private escapeHtml(s = \"\") {\n    return String(s).replace(/[&<>\"']/g, (m) =>\n      ({ \"&\": \"&amp;\", \"<\": \"&lt;\", \">\": \"&gt;\", '\"': \"&quot;\", \"'\": \"&#39;\" } as any)[m]\n    );\n  }\n\n  private async fetchSubjects(): Promise<ISubject[]> {\n    const res = await fetch(this.API_SUBJECTS);\n    if (!res.ok) throw new Error(\"Erro ao carregar mat\u00E9rias\");\n    return res.json();\n  }\n\n  private renderList(items: ISubject[]) {\n    const container = this.$(\"#subject-list\")!;\n    container.innerHTML = \"\";\n\n    if (!items.length) {\n      container.innerHTML = `\n        <div class=\"col-12\">\n          <div class=\"alert alert-info\">Nenhuma mat\u00E9ria cadastrada ainda.</div>\n        </div>`;\n      return;\n    }\n\n    for (const subject of items) {\n      const enrollment = this.userEnrollments.find(enrollment => enrollment.materiaId === subject.id);\n      const enrollButton = this.getEnrollButton(subject.id!, enrollment);\n\n      const col = document.createElement(\"div\");\n      col.className = \"col-md-4 mb-3\";\n      col.innerHTML = `\n        <div class=\"card h-100\">\n          <div class=\"card-body\">\n            <h5 class=\"card-title\">${this.escapeHtml(subject.nome)}</h5>\n            <p class=\"card-text\">${this.escapeHtml(subject.descricao || \"\")}</p>\n            <p class=\"small text-muted\">Professor: ${this.escapeHtml(subject.professor?.nome ?? \"\u2014\")}</p>\n            <p class=\"text-muted small\">\n              ${this.escapeHtml(\n                subject.horario\n                  ? subject.horario + (subject.sala ? \" \u2022 Sala \" + subject.sala : \"\")\n                  : subject.sala\n                  ? \"Sala \" + subject.sala\n                  : \"\"\n              )}\n            </p>\n            ${enrollment ? `<button class=\"btn btn-sm btn-outline-primary me-2\" data-edit=\"${subject.id}-details\">Detalhes</button>` : \"\"}\n            ${enrollButton}\n          </div>\n        </div>`;\n      container.appendChild(col);\n    }\n  }\n\n  private getEnrollButton(subjectId: number, enrollment?: IEnrollment): string {\n    if (!this.currentUser) {\n      return `<button class=\"btn btn-sm btn-secondary\" disabled>Login para matricular</button>`;\n    }\n\n    if (enrollment) {\n      return `<button class=\"btn btn-sm btn-danger\" data-unenroll=\"${enrollment.id}\">\n        <i class=\"bi bi-x-circle\"></i> Desmatricular\n      </button>`;\n    }\n\n    return `<button class=\"btn btn-sm btn-success\" data-enroll=\"${subjectId}\">\n      <i class=\"bi bi-check-circle\"></i> Matricular\n    </button>`;\n  }\n\n  private async loadAndRender() {\n    try {\n      const subjects = await this.fetchSubjects();\n      this.renderList(subjects);\n    } catch (err) {\n      const container = this.$(\"#subject-list\")!;\n      container.innerHTML = `\n        <div class=\"col-12\">\n          <div class=\"alert alert-danger\">Erro ao carregar mat\u00E9rias.</div>\n        </div>`;\n    }\n  }\n}"],
  "mappings": "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",
  "names": ["enrollment"]
}
